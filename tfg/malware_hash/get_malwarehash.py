import subprocess
import sys, os
import json

from stix2 import Indicator

def cmd(cmd):
    """Executes the command in cmd and exits if it fails"""
    res = subprocess.call(cmd, shell=True)
    if res != 0:
        # logger.error(f'Error: The result was {res} when executing command "{cmd}".')
        print_error(f'[-] Error: The result was {res} when executing command "{cmd}".')
        sys.exit(1)

requests=[]
hashes=[]
hashes_stix=[]
hashes_stix2json=[]

def get_malwarehash():
    with open('./malware_hash/malwarehash_request.txt') as file:
        for domain in file:
            if domain not in requests:
                requests.append(domain.rstrip('\n'))
    for request in requests:
        cmd(f"{request} -s >> hashes.txt")
        with open('hashes.txt') as file:
            data = json.load(file)
            for p in data:
                hashes.append(p)
        cmd('rm hashes.txt')
    return hashes

def malwarehash2stix(malwarehash):
    for hash in malwarehash:
        hashes_stix.append(Indicator(name="Hash of malware file",
                                        pattern="[file:hashes.MD5 = '" + hash['md5'] + "']",
                                        pattern_type="stix"))
        hashes_stix.append(Indicator(name="Hash of malware file",
                                        pattern="[file:hashes.'SHA-1' = '" + hash['sha1'] + "']",
                                        pattern_type="stix"))
        hashes_stix.append(Indicator(name="Hash of malware file",
                                        pattern="[file:hashes.'SHA-256' = '" + hash['sha256'] + "']",
                                        pattern_type="stix"))
    for hash in hashes_stix:
        hashes_stix2json.append({"type" : hash["type"],
                                    "spec_version" : hash["spec_version"],
                                    "id" : hash["id"],
                                    "created" : str(hash["created"]),
                                    "modified" : str(hash["modified"]),
                                    "name" : hash["name"],
                                    "pattern" : hash["pattern"],
                                    "pattern_type" : hash["pattern_type"],
                                    "pattern_version" : hash["pattern_version"] ,
                                    "valid_from" : str(hash["valid_from"])})
    return hashes_stix2json
